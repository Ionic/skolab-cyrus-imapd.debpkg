From fb009e2dcd16855717e71c49fdc7db8fc2bf7971 Mon Sep 17 00:00:00 2001
From: Ken Murchison <murch@andrew.cmu.edu>
Date: Fri, 25 Mar 2011 15:59:33 +0000
Subject: Fix  Bug 3394 -  imtest bug leads to null mechlist processing

---
--- a/imtest/imtest.c
+++ b/imtest/imtest.c
@@ -1486,10 +1486,6 @@ static char *ask_capability(struct proto
     }
 
     do { /* look for the end of the capabilities */
-	if (ret) {
-	    free(ret);
-	    ret = NULL;
-	}
 	if (prot_fgets(str, sizeof(str), pin) == NULL) {
 	    if (!*str) imtest_fatal("prot layer failure");
 	    else break;
@@ -1511,6 +1507,8 @@ static char *ask_capability(struct proto
 	/* check for auth */
 	if (prot->capa_cmd.auth &&
 	    (tmp = strstr(str, prot->capa_cmd.auth)) != NULL) {
+	    if (ret) free(ret);
+
 	    if (prot->capa_cmd.parse_mechlist)
 		ret = prot->capa_cmd.parse_mechlist(str, prot);
 	    else
