From: Bron Gondwana <brong@fastmail.fm>
Date: Mon, 11 Feb 2019 21:27:43 +1100
Subject: [PATCH] conversations: update the G keys even if the message has no
 threadid

---
 imap/conversations.c | 16 ++++++++++++++++
 1 file changed, 16 insertions(+)

diff --git a/imap/conversations.c b/imap/conversations.c
index 5db9254..0d2db30 100644
--- a/imap/conversations.c
+++ b/imap/conversations.c
@@ -1869,6 +1869,22 @@ EXPORTED int conversations_update_record(struct conversations_state *cstate,
     }
 
     const struct index_record *record = new ? new : old;
+
+    // always update the GUID information first, as it's used for search
+    // even if conversations have not been set on this email
+    if (new) {
+        if (!old) {
+            r = conversations_set_guid(cstate, mailbox, new, /*add*/1);
+            if (r) return r;
+        }
+    }
+    else {
+        if (old) {
+            r = conversations_set_guid(cstate, mailbox, old, /*add*/0);
+            if (r) return r;
+        }
+    }
+
     if (new && !old) {
         /* add the conversation */
         r = mailbox_cacherecord(mailbox, new); /* make sure it's loaded */
