From: Bron Gondwana <brong@fastmail.fm>
Date: Mon, 11 Feb 2019 21:46:05 +1100
Subject: [PATCH] conversations: actually,
 need to update GUID counts after calculating CID

---
 imap/conversations.c | 15 +++++++++++++++
 1 file changed, 15 insertions(+)

diff --git a/imap/conversations.c b/imap/conversations.c
index 0d2db30..f90023b 100644
--- a/imap/conversations.c
+++ b/imap/conversations.c
@@ -1885,6 +1885,21 @@ EXPORTED int conversations_update_record(struct conversations_state *cstate,
         }
     }
 
+    // always update the GUID information first, as it's used for search
+    // even if conversations have not been set on this email
+    if (new) {
+        if (!old) {
+            r = conversations_set_guid(cstate, mailbox, new, /*add*/1);
+            if (r) return r;
+        }
+    }
+    else {
+        if (old) {
+            r = conversations_set_guid(cstate, mailbox, old, /*add*/0);
+            if (r) return r;
+        }
+    }
+
     if (new && !old) {
         /* add the conversation */
         r = mailbox_cacherecord(mailbox, new); /* make sure it's loaded */
