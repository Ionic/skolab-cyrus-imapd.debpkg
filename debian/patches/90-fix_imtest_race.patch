--- cyrus-imapd-2.4.orig/imtest/imtest.c
+++ cyrus-imapd-2.4/imtest/imtest.c
@@ -1206,6 +1206,24 @@ static void sigint_handler(int sig __att
     gotsigint = 1;
 }
 
+/* If SSL_read() reads a record with more than PROT_BUFSIZE plaintext
+ * bytes, s->cnt can reach 0 even though more data is available.
+ * Check SSL_pending() in that case, otherwise more data might be
+ * available to SSL_read() but the read state could still be cleared
+ * on the file descriptor. */
+static int remaining(struct protstream *s)
+{
+#ifdef HAVE_SSL
+    if (s->cnt == 0 && s->tls_conn != NULL) {
+	int n = SSL_pending(s->tls_conn);
+	if (verbose)
+	    printf("SSL_pending=%d\n", n);
+	return n;
+    }
+#endif
+    return s->cnt;
+}
+
 /* This needs to support 3 modes:
  *
  * 1. Terminal Interface Only
@@ -1370,7 +1388,7 @@ static void interactive(struct protocol_
 		    buf[count] = '\0';
 		    printf("%s", buf); 
 		}
-	    } while (pin->cnt > 0);
+	    } while (remaining(pin) > 0);
 	} else if ((FD_ISSET(fd, &rset)) && (FD_ISSET(sock, &wset))
 		   && (donewritingfile == 0)) {
 	    /* This does input for both socket and file modes */
