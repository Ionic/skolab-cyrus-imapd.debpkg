Description: fix privilege escalation
 Only allow reuse of auth creds on a persistent connection against a backend
 server in a Murder
Author: Ken Murchison <murch@fastmail.com>
Origin: upstream, https://github.com/cyrusimap/cyrus-imapd/commit/e675bf7
Bug: https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2019-18928
Forwarded: not-needed
Reviewed-By: Xavier Guimard <yadd@debian.org>
Last-Update: 2019-11-19

--- a/imap/httpd.c
+++ b/imap/httpd.c
@@ -1729,6 +1729,25 @@
         txn->auth_chal.scheme = NULL;
     }
 
+    /* Drop auth credentials, if not a backend in a Murder */
+    else if (!config_mupdate_server || !config_getstring(IMAPOPT_PROXYSERVERS)) {
+        syslog(LOG_DEBUG, "drop auth creds");
+
+        free(httpd_userid);
+        httpd_userid = NULL;
+
+        free(httpd_extrafolder);
+        httpd_extrafolder = NULL;
+
+        free(httpd_extradomain);
+        httpd_extradomain = NULL;
+
+        if (httpd_authstate) {
+            auth_freestate(httpd_authstate);
+            httpd_authstate = NULL;
+        }
+    }
+
     /* Perform proxy authorization, if necessary */
     else if (saslprops.authid &&
              (hdr = spool_getheader(txn->req_hdrs, "Authorize-As")) &&
