Description: annotate: don't allow everyone to write shared server entries
Author: Bron Gondwana <brong@fastmail.fm>
Origin: upstream, https://github.com/cyrusimap/cyrus-imapd/commit/621f9e41
Bug: https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2021-32056
Forwarded: not-needed
Reviewed-By: Yadd <yadd@debian.org>
Last-Update: 2021-05-10

---
 imap/annotate.c | 24 ++++++++++++------------
 1 file changed, 12 insertions(+), 12 deletions(-)

diff --git a/imap/annotate.c b/imap/annotate.c
index dc59a3b50..a5462d6e5 100644
--- a/imap/annotate.c
+++ b/imap/annotate.c
@@ -2788,15 +2788,20 @@ static int write_entry(struct mailbox *mailbox,
 
     keylen = make_key(mboxname, uid, entry, userid, key, sizeof(key));
 
-    if (mailbox) {
-        struct annotate_metadata oldmdata;
-        r = read_old_value(d, key, keylen, &oldval, &oldmdata);
-        if (r) goto out;
+    struct annotate_metadata oldmdata;
+    r = read_old_value(d, key, keylen, &oldval, &oldmdata);
+    if (r) goto out;
 
-        /* if the value is identical, don't touch the mailbox */
-        if (oldval.len == value->len && (!value->len || !memcmp(oldval.s, value->s, value->len)))
-            goto out;
+    /* if the value is identical, don't touch the mailbox */
+    if (oldval.len == value->len && (!value->len || !memcmp(oldval.s, value->s, value->len)))
+        goto out;
+
+    if (!maywrite) {
+        r = IMAP_PERMISSION_DENIED;
+        if (r) goto out;
+    }
 
+    if (mailbox) {
         if (!ignorequota) {
             quota_t qdiffs[QUOTA_NUMRESOURCES] = QUOTA_DIFFS_DONTCARE_INITIALIZER;
             qdiffs[QUOTA_ANNOTSTORAGE] = value->len - (quota_t)oldval.len;
@@ -2804,11 +2809,6 @@ static int write_entry(struct mailbox *mailbox,
             if (r) goto out;
         }
 
-        if (!maywrite) {
-            r = IMAP_PERMISSION_DENIED;
-            if (r) goto out;
-        }
-
         /* do the annot-changed here before altering the DB */
         mailbox_annot_changed(mailbox, uid, entry, userid, &oldval, value, silent);
 
